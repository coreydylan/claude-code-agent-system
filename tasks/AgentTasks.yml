# Agent System Task Management
# Integration between agents and infrastructure

version: '3'

vars:
  AGENT_WORKSPACE: '{{default "." .AGENT_WORKSPACE}}'
  # CLAUDE_API_KEY will be read from environment

tasks:
  # ğŸ¤– Agent System Management
  ready:
    desc: "Prepare agent system for orchestration"
    cmds:
      - echo "ğŸ¤– Preparing agent system..."
      - task: check-onboarding
      - task: validate-context
      - task: initialize-agents
      - echo "âœ… Agent system ready"

  check-onboarding:
    internal: true
    cmds:
      - |
        if [ ! -f "PROJECT_MANIFESTO.md" ]; then
          echo "ğŸ“‹ Repository not onboarded. Running onboarding..."
          if [ -f "scripts/repo-onboarding.sh" ]; then
            bash scripts/repo-onboarding.sh . || echo "âš ï¸  Onboarding script not found or failed"
          else
            echo "âš ï¸  Onboarding script not found at scripts/repo-onboarding.sh"
          fi
        else
          echo "âœ… Repository already onboarded"
        fi

  validate-context:
    internal: true
    cmds:
      - |
        echo "ğŸ” Validating agent context..."
        MISSING=""
        
        # Check essential files
        [ ! -f "PROJECT_MANIFESTO.md" ] && MISSING="$MISSING PROJECT_MANIFESTO.md"
        [ ! -f "PROJECT_LOG.md" ] && MISSING="$MISSING PROJECT_LOG.md"
        [ ! -d "TASKS" ] && MISSING="$MISSING TASKS/"
        
        if [ -n "$MISSING" ]; then
          echo "âš ï¸  Missing agent context files:$MISSING"
          echo "   Run repo onboarding to generate these files"
        else
          echo "âœ… Agent context validated"
        fi

  initialize-agents:
    internal: true
    cmds:
      - |
        echo "ğŸš€ Initializing agent system..."
        
        # Create agent workspace if needed
        mkdir -p {{.AGENT_WORKSPACE}}/.claude-agents
        
        # Initialize agent CLI if available
        if command -v claude-agents >/dev/null 2>&1; then
          echo "âœ… Claude Agents CLI ready"
        else
          echo "âš ï¸  Claude Agents CLI not found. Install with:"
          echo "   npm install -g @claude/agents"
        fi

  # ğŸ¯ Agent Spawning
  spawn:
    desc: "Spawn specific agent"
    cmds:
      - |
        AGENT_NAME="{{.CLI_ARGS}}"
        if [ -z "$AGENT_NAME" ]; then
          echo "âŒ Please specify an agent name"
          echo "Usage: task agents:spawn -- <agent-name>"
          exit 1
        fi
        
        echo "ğŸš€ Spawning agent: $AGENT_NAME"
        
        # Check if we're in a Claude Code session
        if command -v claude >/dev/null 2>&1; then
          # Use Claude Code's native agent spawning
          echo "Using $AGENT_NAME subagent to handle this task" | claude --non-interactive
        else
          echo "âš ï¸  Claude Code CLI not found. Install with:"
          echo "   curl -fsSL https://claude.ai/install.sh | sh"
          exit 1
        fi

  interactive:
    desc: "Launch interactive agent interface"
    cmds:
      - |
        echo "ğŸ¤– Launching interactive agent interface..."
        
        if command -v claude >/dev/null 2>&1; then
          echo "ğŸš€ Starting Claude Code with agent system ready..."
          echo "ğŸ’¡ Use '/agents' command in Claude Code to manage subagents"
          claude --interactive
        else
          echo "âš ï¸  Claude Code CLI not found. Install with:"
          echo "   curl -fsSL https://claude.ai/install.sh | sh"
          exit 1
        fi

  sequence:
    desc: "Run agent sequence"
    cmds:
      - |
        SEQUENCE_NAME="{{.CLI_ARGS}}"
        if [ -z "$SEQUENCE_NAME" ]; then
          echo "âŒ Please specify a sequence name"
          echo "Usage: task agents:sequence -- <sequence-name>"
          exit 1
        fi
        
        echo "ğŸ¯ Running agent sequence: $SEQUENCE_NAME"
        
        if command -v claude >/dev/null 2>&1; then
          echo "ğŸš€ Starting Claude Code to run $SEQUENCE_NAME sequence..."
          echo "ğŸ’¡ Request the sequence by saying: 'Run the $SEQUENCE_NAME agent sequence'"
          claude --interactive
        else
          echo "âš ï¸  Claude Code CLI not found. Install with:"
          echo "   curl -fsSL https://claude.ai/install.sh | sh"
          exit 1
        fi

  create-agents:
    desc: "Create Claude Code subagents"
    cmds:
      - |
        echo "ğŸ¤– Creating Claude Code subagents..."
        if [ -f "scripts/create-claude-agents.sh" ]; then
          bash scripts/create-claude-agents.sh
        else
          echo "âŒ Agent creation script not found"
          echo "   Expected: scripts/create-claude-agents.sh"
          exit 1
        fi

  # ğŸ“Š Agent Status and Health
  status:
    desc: "Show agent system status"
    cmds:
      - echo "ğŸ“Š Agent System Status"
      - echo "===================="
      - task: list-active
      - echo ""
      - task: health

  list-active:
    desc: "List active agents"
    cmds:
      - |
        echo "ğŸ”„ Active Agents:"
        if command -v claude-agents >/dev/null 2>&1; then
          claude-agents list --active
        else
          echo "   No active agents (CLI not available)"
        fi

  health:
    desc: "Check agent system health"
    cmds:
      - |
        echo "ğŸ¥ Agent System Health:"
        ISSUES=""
        
        # Check API key
        if [ -z "${CLAUDE_API_KEY}" ]; then
          ISSUES="$ISSUES missing-api-key"
          echo "   âŒ Claude API key not set"
        else
          echo "   âœ… Claude API key configured"
        fi
        
        # Check workspace
        if [ ! -d "{{.AGENT_WORKSPACE}}" ]; then
          ISSUES="$ISSUES missing-workspace"
          echo "   âŒ Agent workspace not found: {{.AGENT_WORKSPACE}}"
        else
          echo "   âœ… Agent workspace ready"
        fi
        
        # Check project files
        if [ ! -f "PROJECT_MANIFESTO.md" ]; then
          ISSUES="$ISSUES missing-manifesto"
          echo "   âš ï¸  PROJECT_MANIFESTO.md missing (run onboarding)"
        else
          echo "   âœ… Project manifesto found"
        fi
        
        if [ -z "$ISSUES" ]; then
          echo "   ğŸ‰ All systems healthy!"
        else
          echo "   âš ï¸  Issues detected: $ISSUES"
        fi

  # ğŸ”„ Agent Lifecycle Management
  stop-all:
    desc: "Stop all running agents"
    cmds:
      - |
        echo "ğŸ›‘ Stopping all agents..."
        if command -v claude-agents >/dev/null 2>&1; then
          claude-agents stop --all
        else
          echo "âš ï¸  Cannot stop agents without Claude Agents CLI"
        fi

  restart:
    desc: "Restart agent system"
    cmds:
      - task: stop-all
      - task: ready
      - echo "ğŸ”„ Agent system restarted"

  # ğŸ§¹ Cleanup
  clean:
    desc: "Clean agent workspace"
    cmds:
      - |
        echo "ğŸ§¹ Cleaning agent workspace..."
        if [ -d "{{.AGENT_WORKSPACE}}/.claude-agents" ]; then
          rm -rf {{.AGENT_WORKSPACE}}/.claude-agents/cache
          rm -rf {{.AGENT_WORKSPACE}}/.claude-agents/logs
          echo "âœ… Agent cache and logs cleared"
        else
          echo "âš ï¸  Agent workspace not found"
        fi

  # ğŸ“ Agent Development and Testing
  validate:
    desc: "Validate agent configurations"
    cmds:
      - |
        echo "âœ… Validating agent configurations..."
        
        # Check agent definitions
        if [ -f "src/cli/src/agents/AgentManager.ts" ]; then
          echo "   âœ… Agent manager found"
        else
          echo "   âš ï¸  Agent manager not found"
        fi
        
        # Validate manifesto
        if [ -f "PROJECT_MANIFESTO.md" ]; then
          echo "   âœ… Project manifesto validated"
        else
          echo "   âŒ Project manifesto missing"
        fi

  install:
    desc: "Install agent dependencies"
    cmds:
      - |
        echo "ğŸ“¦ Installing agent dependencies..."
        
        # Install Claude CLI if not present
        if ! command -v claude >/dev/null 2>&1; then
          echo "ğŸ“¥ Installing Claude CLI..."
          npm install -g @anthropic/claude-cli || echo "âš ï¸  Failed to install Claude CLI"
        fi
        
        # Install custom agent CLI if available
        if [ -f "src/cli/package.json" ]; then
          echo "ğŸ“¦ Installing custom agent CLI..."
          cd src/cli && npm install && npm run build
        fi

  update:
    desc: "Update agent system"
    cmds:
      - |
        echo "â¬†ï¸  Updating agent system..."
        
        # Update Claude CLI
        if command -v claude >/dev/null 2>&1; then
          npm update -g @anthropic/claude-cli || echo "âš ï¸  Failed to update Claude CLI"
        fi
        
        # Update custom agents
        if [ -f "src/cli/package.json" ]; then
          cd src/cli && npm update && npm run build
        fi

  # ğŸ“ˆ Agent Metrics
  metrics:
    desc: "Show agent system metrics"
    cmds:
      - |
        echo "ğŸ“ˆ Agent System Metrics:"
        echo "======================="
        
        # Task completion metrics
        if [ -f "TASKS/METRICS.json" ]; then
          echo "ğŸ“Š Task Metrics:"
          cat TASKS/METRICS.json | jq -r '
            "   â€¢ Total Tasks: \(.summary.total_tasks // 0)",
            "   â€¢ Completed: \(.summary.completed // 0)",
            "   â€¢ In Progress: \(.summary.in_progress // 0)",
            "   â€¢ Success Rate: \(.metrics.success_rate // "N/A")%"
          ' 2>/dev/null || echo "   âš ï¸  Could not parse metrics"
        else
          echo "   âš ï¸  No metrics available"
        fi
        
        # Agent activity
        if [ -f "PROJECT_LOG.md" ]; then
          echo ""
          echo "ğŸ¤– Recent Agent Activity:"
          tail -10 PROJECT_LOG.md | grep "###" | while read -r line; do
            echo "   $line"
          done 2>/dev/null || echo "   âš ï¸  No recent activity"
        fi

  # ğŸ”§ Deployment Integration
  deploy-monitors:
    desc: "Deploy agent monitoring to production"
    cmds:
      - |
        echo "ğŸš€ Deploying agent monitoring..."
        
        # Deploy monitoring dashboards
        if [ -f "infrastructure/grafana/agent-dashboard.json" ]; then
          echo "ğŸ“Š Deploying agent dashboards..."
          # Copy to monitoring stack
          cp infrastructure/grafana/agent-dashboard.json docker/grafana/dashboards/
        fi
        
        # Configure alerts
        if [ -f "infrastructure/prometheus/agent-alerts.yml" ]; then
          echo "ğŸš¨ Configuring agent alerts..."
          # Copy to Prometheus config
          cp infrastructure/prometheus/agent-alerts.yml docker/prometheus/
        fi
        
        echo "âœ… Agent monitoring deployed"