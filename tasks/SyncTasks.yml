# Environment Synchronization Tasks
# Sync between local, Vercel, Supabase, and Docker

version: '3'

vars:
  SUPABASE_PROJECT_REF: '{{.SUPABASE_PROJECT_REF}}'
  VERCEL_PROJECT: '{{.VERCEL_PROJECT}}'

tasks:
  # ğŸ”„ Main Sync Command
  all:
    desc: "Sync all environments and configurations"
    cmds:
      - echo "ğŸ”„ Synchronizing all environments..."
      - task: vercel
      - task: supabase
      - task: env
      - task: types
      - task: docker
      - echo "âœ… All environments synchronized"

  # ğŸ“¡ Vercel Sync
  vercel:
    desc: "Sync Vercel environment"
    cmds:
      - echo "ğŸ“¡ Syncing Vercel environment..."
      - task: vercel-pull
      - task: vercel-link-check
      - echo "âœ… Vercel sync completed"

  vercel-pull:
    internal: true
    cmds:
      - |
        if command -v vercel >/dev/null 2>&1; then
          echo "ğŸ“¥ Pulling Vercel environment variables..."
          
          # Pull all environments
          for env in development staging production; do
            if vercel env pull .env.vercel.$env --environment=$env 2>/dev/null; then
              echo "   âœ… Pulled $env environment"
            else
              echo "   âš ï¸  Could not pull $env environment (may not exist)"
            fi
          done
          
          # Pull default development environment
          vercel env pull .env.vercel 2>/dev/null || echo "   âš ï¸  Could not pull default environment"
          
        else
          echo "âš ï¸  Vercel CLI not found - skipping Vercel sync"
        fi

  vercel-link-check:
    internal: true
    cmds:
      - |
        if [ ! -f ".vercel/project.json" ]; then
          echo "ğŸ”— Vercel project not linked"
          echo "   Run 'vercel link' to connect this project to Vercel"
        else
          PROJECT_ID=$(cat .vercel/project.json | grep -o '"projectId":"[^"]*' | cut -d'"' -f4)
          echo "âœ… Linked to Vercel project: $PROJECT_ID"
        fi

  vercel-push:
    desc: "Push local environment to Vercel"
    cmds:
      - |
        ENV_FILE="${CLI_ARGS:-.env.production}"
        TARGET_ENV="production"
        
        if [ ! -f "$ENV_FILE" ]; then
          echo "âŒ Environment file not found: $ENV_FILE"
          exit 1
        fi
        
        echo "ğŸ“¤ Pushing $ENV_FILE to Vercel ($TARGET_ENV)..."
        
        # Clear existing environment variables
        vercel env ls $TARGET_ENV 2>/dev/null | tail -n +2 | while read -r key; do
          if [ -n "$key" ] && [ "$key" != "Key" ]; then
            vercel env rm "$key" $TARGET_ENV --yes >/dev/null 2>&1 || true
          fi
        done
        
        # Push new variables
        while IFS= read -r line; do
          if [[ $line =~ ^([A-Z_][A-Z0-9_]*)=(.*)$ ]]; then
            key="${BASH_REMATCH[1]}"
            value="${BASH_REMATCH[2]}"
            
            # Remove surrounding quotes if present
            value=$(echo "$value" | sed 's/^"\(.*\)"$/\1/')
            
            echo "   Setting $key..."
            echo "$value" | vercel env add "$key" $TARGET_ENV --force >/dev/null || echo "âš ï¸  Failed to set $key"
          fi
        done < "$ENV_FILE"
        
        echo "âœ… Environment variables pushed to Vercel"

  # ğŸ—„ï¸ Supabase Sync
  supabase:
    desc: "Sync Supabase configuration"
    cmds:
      - echo "ğŸ—„ï¸  Syncing Supabase configuration..."
      - task: supabase-start
      - task: supabase-migrate
      - task: supabase-types
      - echo "âœ… Supabase sync completed"

  supabase-start:
    internal: true
    cmds:
      - |
        if command -v supabase >/dev/null 2>&1; then
          if [ -f "supabase/config.toml" ]; then
            echo "ğŸš€ Starting Supabase local..."
            
            # Check if already running
            if supabase status 2>/dev/null | grep -q "Running"; then
              echo "   âœ… Supabase already running"
            else
              supabase start || echo "âš ï¸  Supabase start failed (may already be running)"
            fi
          else
            echo "âš ï¸  Supabase not initialized in this project"
            echo "   Run 'supabase init' to initialize"
          fi
        else
          echo "âš ï¸  Supabase CLI not found - skipping Supabase sync"
        fi

  supabase-migrate:
    internal: true
    cmds:
      - |
        if command -v supabase >/dev/null 2>&1 && [ -f "supabase/config.toml" ]; then
          echo "ğŸ”„ Running Supabase migrations..."
          
          # Run local migrations
          if supabase migration up 2>/dev/null; then
            echo "   âœ… Local migrations completed"
          else
            echo "   âš ï¸  No migrations to apply or migration failed"
          fi
          
          # Sync with remote if configured
          if [ -n "{{.SUPABASE_PROJECT_REF}}" ]; then
            echo "â˜ï¸  Syncing with remote Supabase..."
            supabase db pull --project-ref {{.SUPABASE_PROJECT_REF}} 2>/dev/null || echo "   âš ï¸  Remote sync failed"
          fi
        fi

  supabase-types:
    internal: true
    cmds:
      - |
        if command -v supabase >/dev/null 2>&1; then
          echo "ğŸ“ Generating Supabase types..."
          mkdir -p types
          
          # Generate from local instance
          if supabase gen types typescript --local > types/supabase.ts 2>/dev/null; then
            echo "   âœ… Types generated from local instance"
          elif [ -n "{{.SUPABASE_PROJECT_REF}}" ]; then
            echo "   Generating types from remote instance..."
            supabase gen types typescript --project-id {{.SUPABASE_PROJECT_REF}} > types/supabase.ts 2>/dev/null || echo "   âš ï¸  Type generation failed"
          else
            echo "   âš ï¸  Could not generate types (no local or remote instance)"
          fi
        fi

  # ğŸ”§ Environment File Sync
  env:
    desc: "Sync environment files"
    cmds:
      - echo "ğŸ”§ Synchronizing environment files..."
      - task: env-merge
      - task: env-validate
      - echo "âœ… Environment sync completed"

  env-merge:
    internal: true
    cmds:
      - |
        echo "ğŸ”„ Merging environment files..."
        
        # Create merged .env file
        node -e "
          const fs = require('fs');
          const path = require('path');
          
          // Priority order (later overrides earlier)
          const envFiles = [
            '.env.example',
            '.env.vercel',
            '.env.vercel.development', 
            '.env.local'
          ];
          
          let merged = {};
          let sources = [];
          
          envFiles.forEach(file => {
            if (fs.existsSync(file)) {
              const content = fs.readFileSync(file, 'utf8');
              const lines = content.split('\n');
              
              lines.forEach(line => {
                line = line.trim();
                if (line && !line.startsWith('#') && line.includes('=')) {
                  const [key, ...valueParts] = line.split('=');
                  const value = valueParts.join('=');
                  merged[key] = value;
                }
              });
              
              sources.push(file);
            }
          });
          
          if (sources.length > 0) {
            const envContent = Object.entries(merged)
              .map(([key, value]) => \`\${key}=\${value}\`)
              .join('\n');
            
            fs.writeFileSync('.env', envContent);
            console.log(\`   âœ… Merged environment from: \${sources.join(', ')}\`);
          } else {
            console.log('   âš ï¸  No environment files found to merge');
          }
        " 2>/dev/null || echo "   âš ï¸  Environment merge failed"

  env-validate:
    internal: true
    cmds:
      - |
        echo "âœ… Validating environment configuration..."
        
        if [ -f ".env" ]; then
          # Check for common required variables
          REQUIRED_VARS="DATABASE_URL NEXT_PUBLIC_SUPABASE_URL NEXT_PUBLIC_SUPABASE_ANON_KEY"
          MISSING=""
          
          for var in $REQUIRED_VARS; do
            if ! grep -q "^$var=" .env 2>/dev/null; then
              MISSING="$MISSING $var"
            fi
          done
          
          if [ -n "$MISSING" ]; then
            echo "   âš ï¸  Missing environment variables:$MISSING"
          else
            echo "   âœ… All required environment variables present"
          fi
          
          # Count total variables
          VAR_COUNT=$(grep -c "^[A-Z]" .env 2>/dev/null || echo 0)
          echo "   ğŸ“Š Total environment variables: $VAR_COUNT"
        else
          echo "   âŒ No .env file found"
        fi

  # ğŸ“ Type Generation
  types:
    desc: "Generate and sync TypeScript types"
    cmds:
      - echo "ğŸ“ Generating TypeScript types..."
      - task: types-supabase
      - task: types-validate
      - echo "âœ… Type generation completed"

  types-supabase:
    internal: true
    cmds:
      - task: supabase-types

  types-validate:
    internal: true
    cmds:
      - |
        if [ -f "package.json" ] && grep -q '"typescript"' package.json; then
          echo "ğŸ” Validating TypeScript configuration..."
          
          if command -v tsc >/dev/null 2>&1; then
            if npx tsc --noEmit --skipLibCheck 2>/dev/null; then
              echo "   âœ… TypeScript validation passed"
            else
              echo "   âš ï¸  TypeScript validation found issues"
            fi
          else
            echo "   âš ï¸  TypeScript compiler not found"
          fi
        else
          echo "   âš ï¸  TypeScript not configured in this project"
        fi

  # ğŸ³ Docker Environment Sync
  docker:
    desc: "Sync Docker environment"
    cmds:
      - echo "ğŸ³ Syncing Docker environment..."
      - task: docker-env-sync
      - task: docker-compose-validate
      - echo "âœ… Docker sync completed"

  docker-env-sync:
    internal: true
    cmds:
      - |
        echo "ğŸ”„ Syncing environment to Docker..."
        
        # Copy environment file for Docker
        if [ -f ".env" ]; then
          cp .env .env.docker
          echo "   âœ… Environment copied to .env.docker"
        else
          echo "   âš ï¸  No .env file to sync"
        fi
        
        # Update docker-compose environment
        if [ -f "docker-compose.dev.yml" ]; then
          echo "   ğŸ“‹ Docker Compose configuration found"
        else
          echo "   âš ï¸  No Docker Compose configuration found"
        fi

  docker-compose-validate:
    internal: true
    cmds:
      - |
        echo "âœ… Validating Docker Compose configuration..."
        
        COMPOSE_FILES="docker-compose.yml docker-compose.dev.yml"
        
        for file in $COMPOSE_FILES; do
          if [ -f "$file" ]; then
            if docker-compose -f "$file" config >/dev/null 2>&1; then
              echo "   âœ… $file is valid"
            else
              echo "   âŒ $file has configuration errors"
            fi
          fi
        done

  # ğŸ” Sync Status
  status:
    desc: "Show synchronization status"
    cmds:
      - echo "ğŸ“Š Synchronization Status"
      - echo "========================"
      - task: status-vercel
      - task: status-supabase
      - task: status-env
      - task: status-docker

  status-vercel:
    internal: true
    cmds:
      - |
        echo "ğŸ“¡ Vercel Status:"
        
        if [ -f ".vercel/project.json" ]; then
          PROJECT_ID=$(cat .vercel/project.json | grep -o '"projectId":"[^"]*' | cut -d'"' -f4 2>/dev/null)
          echo "   âœ… Linked to project: $PROJECT_ID"
        else
          echo "   âŒ Not linked to Vercel project"
        fi
        
        # Check for Vercel env files
        for env in .env.vercel .env.vercel.development .env.vercel.staging .env.vercel.production; do
          if [ -f "$env" ]; then
            VAR_COUNT=$(grep -c "^[A-Z]" "$env" 2>/dev/null || echo 0)
            echo "   ğŸ“„ $env: $VAR_COUNT variables"
          fi
        done

  status-supabase:
    internal: true
    cmds:
      - |
        echo "ğŸ—„ï¸  Supabase Status:"
        
        if [ -f "supabase/config.toml" ]; then
          echo "   âœ… Supabase initialized"
          
          if command -v supabase >/dev/null 2>&1; then
            if supabase status 2>/dev/null | grep -q "Running"; then
              echo "   ğŸŸ¢ Local instance: Running"
            else
              echo "   âšª Local instance: Stopped"
            fi
          fi
        else
          echo "   âŒ Supabase not initialized"
        fi
        
        # Check types file
        if [ -f "types/supabase.ts" ]; then
          SIZE=$(wc -c < "types/supabase.ts" 2>/dev/null || echo 0)
          echo "   ğŸ“ Types file: $SIZE bytes"
        else
          echo "   âŒ No types file generated"
        fi

  status-env:
    internal: true
    cmds:
      - |
        echo "ğŸ”§ Environment Status:"
        
        # Count variables in each env file
        for env in .env.example .env.local .env .env.docker; do
          if [ -f "$env" ]; then
            VAR_COUNT=$(grep -c "^[A-Z]" "$env" 2>/dev/null || echo 0)
            echo "   ğŸ“„ $env: $VAR_COUNT variables"
          fi
        done
        
        # Check for missing required files
        if [ ! -f ".env" ]; then
          echo "   âš ï¸  .env file missing - run 'task sync:env' to create"
        fi

  status-docker:
    internal: true
    cmds:
      - |
        echo "ğŸ³ Docker Status:"
        
        if command -v docker >/dev/null 2>&1; then
          if docker info >/dev/null 2>&1; then
            echo "   âœ… Docker daemon: Running"
            
            # Check for compose files
            for file in docker-compose.yml docker-compose.dev.yml; do
              if [ -f "$file" ]; then
                echo "   ğŸ“„ $file: Available"
              fi
            done
          else
            echo "   âŒ Docker daemon: Not running"
          fi
        else
          echo "   âŒ Docker not installed"
        fi

  # ğŸ§¹ Sync Cleanup
  clean:
    desc: "Clean sync artifacts"
    cmds:
      - |
        echo "ğŸ§¹ Cleaning sync artifacts..."
        
        # Remove temporary sync files
        rm -f .env.vercel.* .env.docker .env.backup
        
        # Clean Supabase cache
        if [ -d "supabase/.temp" ]; then
          rm -rf supabase/.temp
        fi
        
        echo "âœ… Sync artifacts cleaned"

  # ğŸ”„ Force Refresh
  refresh:
    desc: "Force refresh all synchronization"
    cmds:
      - echo "ğŸ”„ Force refreshing all synchronization..."
      - task: clean
      - task: all
      - echo "âœ… Full refresh completed"